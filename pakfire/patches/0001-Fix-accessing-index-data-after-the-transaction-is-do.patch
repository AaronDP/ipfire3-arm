From b856696a0a8173eaacdd03833971272de06118ce Mon Sep 17 00:00:00 2001
From: Michael Tremer <michael.tremer@ipfire.org>
Date: Sat, 14 Apr 2012 21:16:30 +0200
Subject: [PATCH 01/16] Fix accessing index data after the transaction is
 done.

---
 python/pakfire/client/builder.py    |    1 +
 python/pakfire/repository/system.py |    3 +++
 2 files changed, 4 insertions(+)

diff --git a/python/pakfire/client/builder.py b/python/pakfire/client/builder.py
index a039e65..2ade5dc 100644
--- a/python/pakfire/client/builder.py
+++ b/python/pakfire/client/builder.py
@@ -334,6 +334,7 @@ class ClientBuilder(object):
 		pkgs = []
 
 		for pkg in installed_packages:
+			assert pkg.uuid, "%s has got no UUID"
 			pkgs.append((pkg.friendly_name, pkg.uuid))
 
 		return self.conn.build_upload_buildroot(self.build_id, pkgs)
diff --git a/python/pakfire/repository/system.py b/python/pakfire/repository/system.py
index 642c4bd..5dcdd04 100644
--- a/python/pakfire/repository/system.py
+++ b/python/pakfire/repository/system.py
@@ -52,6 +52,9 @@ class RepositorySystem(base.RepositoryFactory):
 		# Commit the database to disk.
 		self.db.commit()
 
+		# Make sure that all data in the index is accessable.
+		self.index.optimize()
+
 	def add_package(self, pkg):
 		# Add package to the database.
 		self.db.add_package(pkg)
-- 
1.7.10.4

