#!/bin/sh
###############################################################################
#                                                                             #
# IPFire.org - A linux based firewall                                         #
# Copyright (C) 2009  Michael Tremer & Christian Schmidt                      #
#                                                                             #
# This program is free software: you can redistribute it and/or modify        #
# it under the terms of the GNU General Public License as published by        #
# the Free Software Foundation, either version 3 of the License, or           #
# (at your option) any later version.                                         #
#                                                                             #
# This program is distributed in the hope that it will be useful,             #
# but WITHOUT ANY WARRANTY; without even the implied warranty of              #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the               #
# GNU General Public License for more details.                                #
#                                                                             #
# You should have received a copy of the GNU General Public License           #
# along with this program.  If not, see <http://www.gnu.org/licenses/>.       #
#                                                                             #
###############################################################################

CONFIG_DIR=/etc/sysconfig/networking

CONFIG_ZONES=${CONFIG_DIR}/zones
CONFIG_PORTS=${CONFIG_DIR}/ports

function is_mac() {
	egrep -q "^[0-9a-f][0-9a-f]\:[0-9a-f][0-9a-f]\:[0-9a-f][0-9a-f]\:[0-9a-f][0-9a-f]\:[0-9a-f][0-9a-f]\:[0-9a-f][0-9a-f]$" <<<$1
}

function get_device_by_mac() {
	local mac
	local i

	mac=$1

	for i in /sys/class/net/*; do
		if [ "$(cat $i/address)" = "$mac" ]; then
			grep -q "^${i##*/}" /proc/net/vlan/config 2>/dev/null && continue
			echo ${i##*/}
			break
		fi
	done
}

function get_device_by_mac_and_vid() {
	local mac
	local vid

	mac=$1
	vid=$2

	local i
	local VID
	local DEVICE
	grep '|' < /proc/net/vlan/config 2>/dev/null | sed "s/|//g" | \
		while read DEVICE VID PARENT; do
			if [ "${vid}" = "${VID}" ] && [ "$(macify ${PARENT})" = "${mac}" ]; then
				echo "${DEVICE}"
				return 0
			fi
		done
	return 1
}

function get_device() {
	if [ ${#@} -gt 1 ]; then
		get_device_by_mac_and_vid $@
	else
		get_device_by_mac $@
	fi
}

function get_mac_by_device() {
	local device
	device=$1
	if [ -d "/sys/class/net/$device" ]; then
		cat /sys/class/net/$device/address
		return 0
	fi
	return 1
}

function get_mac() {
	get_mac_by_device $@
}

function devicify() {
	local device
	local mac

	device=$1

	if is_mac ${device}; then
		mac=${device}
		device=$(get_device_by_mac ${device})
	fi
	echo ${device}
}

function macify() {
	local input
	local mac
	
	input=$1
	
	if is_mac ${input}; then
		mac=${input}
	else
		mac=$(get_mac_by_device ${input})
	fi
	echo ${mac}
}

function device_exists() {
	ip link show $(devicify ${1}) &>/dev/null
}

function rename_device() {
	local source
	local destination
	
	source=$1
	destination=$2

	# Check if devices exist
	if ! device_exists ${source} || device_exists ${destination}; then
		return 4
	fi

	ip link set ${source} name ${destination}
	return $?
}

function zone_exists() {
	[ -e "$CONFIG_ZONES/$1" ] #|| device_exists $@
}

function bridge_devices() {
	local bridge
	bridge=$1
	[ -z "${bridge}" ] && return 2
	brctl show | grep "^${bridge}" | awk '{ print $NF }' | grep -v "^interfaces$"
}

function zone_add_port() {
	local zone
	local port

	zone=${1}
	port=${2}

	brctl addif ${zone} ${port}
}

function zone_del_port() {
	local zone
	local port

	zone=${1}
	port=${2}

	brctl delif ${zone} ${port}
}

function all_zones() {
	local zone
	for zone in ${CONFIG_ZONES}/*; do
		[ -d "${zone}" ] && echo ${zone}
	done
}
