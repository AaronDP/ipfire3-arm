#!/bin/sh
########################################################################
# Begin $NETWORK_DEVICES/services/ipv4-static
#
# Description : IPV4 Static Boot Script
#
# Authors     : Nathan Coulson - nathan@linuxfromscratch.org
#               Kevin P. Fleming - kpfleming@linuxfromscratch.org
#
# Version     : 00.00
#
# Notes       :
#
########################################################################

. /lib/lsb/init-functions
[ -n "${CONFIG}" ] && . ${CONFIG}

zone=$1

if [ -z "${IP}" ]; then
	log_failure_msg "IP variable missing from ${CONFIG}, cannot continue."
	exit 1
fi

if [ -z "${PREFIX}" -a -z "${PEER}" ]; then
	log_warning_msg "PREFIX variable missing from ${CONFIG}, assuming 24."
	PREFIX=24
	args="${args} ${IP}/${PREFIX}"
elif [ -n "${PREFIX}" -a -n "${PEER}" ]; then
	log_failure_msg "PREFIX and PEER both specified in ${CONFIG}, cannot continue."
	exit 1
elif [ -n "${PREFIX}" ]; then
	args="${args} ${IP}/${PREFIX}"
elif [ -n "${PEER}" ]; then
	args="${args} ${IP} peer ${PEER}"
fi

if [ -n "${BROADCAST}" ]; then
	args="${args} broadcast ${BROADCAST}"
fi

if [ -n "${SOURCE}" ]; then
	args="${args} src ${SOURCE}"
fi

case "${2}" in
	up)
		MESSAGE="Adding IPv4 address ${IP} to zone ${zone} interface..."
		ip addr add ${args} dev ${zone}
		evaluate_retval
	
		if [ -n "${GATEWAY}" ]; then
			if ip route | grep -q default; then
				log_warning_msg "Gateway already setup; skipping." ${WARNING}
			else
				MESSAGE="Setting up default gateway..."
				ip route add default via ${GATEWAY} dev ${zone}
				evaluate_retval
			 fi
		fi
	;;
	
	down)
		if [ -n "${GATEWAY}" ];	then
			MESSAGE="Removing default gateway..."
			ip route del default
			evaluate_retval
		fi
	
		MESSAGE="Removing IPv4 address ${IP} from zone ${zone}..."
		ip addr del ${args} dev ${zone}
		evaluate_retval
	;;
	
	config)
		: # TODO
	;;
	
	*)
		echo "Usage: ${0} [interface] {up|down|config}"
		exit 1
	;;
esac

# End $NETWORK_DEVICES/services/ipv4-static
